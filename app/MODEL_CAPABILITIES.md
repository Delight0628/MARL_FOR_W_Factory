# 🤖 训练模型能力说明

## 📋 概述

当前训练的MARL模型支持的自定义调度范围和限制说明。

---

## ✅ 模型**完全支持**的功能

### 1. **订单到达时间 (Arrival Time)**
- ✅ **完全支持**
- **原因**：
  - `Order`类和`Part`类在设计时就包含了`arrival_time`字段
  - 环境在`_part_process`中会等待零件到达时间：`if part.start_time > self.env.now: yield self.env.timeout(...)`
  - 模型观测中的时间松弛度计算会考虑零件的实际到达时间
- **使用范围**：0-500分钟的任意到达时间

### 2. **自定义产品工艺路线**
- ✅ **完全支持**
- **原因**：
  - 产品类型只是工艺路线的索引键，模型不直接看产品名称
  - 模型通过观测零件的加工步骤、剩余工序、加工时间等特征来决策
  - 只要工艺路线定义了`station`和`time`，环境就能正确处理
- **使用范围**：
  - 任意工作站组合（必须是5个系统工作站之一）
  - 任意加工时间（1-100分钟建议范围）
  - 任意工序数量（1-10个工序）

### 3. **随机订单配置**
- ✅ **完全支持**
- **原因**：
  - 模型在泛化训练阶段就使用`generate_random_orders()`进行训练
  - 训练配置中明确支持5-8个订单，每个订单3-12个零件
- **使用范围**：
  - 订单数量：3-10个
  - 每订单零件数：1-20个（建议3-15个）
  - 交期：100-2000分钟
  - 优先级：1-5

### 4. **订单优先级**
- ✅ **完全支持**
- **原因**：优先级是观测空间的一部分，模型会根据优先级做出决策

### 5. **订单交期 (Due Date)**
- ✅ **完全支持**
- **原因**：
  - 交期通过松弛时间影响模型决策
  - 延期惩罚是奖励函数的核心组成部分

---

## ⚠️ 模型**部分支持**的功能

### 1. **订单数量和零件总数**
- ⚠️ **有限制**
- **支持范围**：
  - 总零件数：建议15-60个
  - 如果零件数过少（<10），模型可能过度优化
  - 如果零件数过多（>80），可能超出训练时的复杂度
- **原因**：
  - 模型在训练时使用的订单规模为20-50个零件
  - 观测空间中的候选工件数量固定为10个
  - 队列容量有限制

### 2. **仿真时间范围**
- ⚠️ **有限制**
- **支持范围**：标准600分钟（10小时）± 50%
- **原因**：
  - 时间归一化基于`SIMULATION_TIME = 600`
  - 如果任务明显超时（理论完工时间 > 1200min），模型性能会下降

---

## ❌ 模型**不支持**的功能（需重新训练）

### 1. **自定义工作站数量或类型**
- ❌ **不支持，需重新训练**
- **原因**：
  - 观测空间维度固定：
    ```python
    # Agent自身特征中的one-hot编码：5个工作站 = 5维
    # 全局状态：5个工作站 × 3个特征 = 15维
    ```
  - 如果增加/减少工作站，观测维度会变化，导致模型无法加载
- **如何支持**：
  1. 修改`WORKSTATIONS`配置
  2. 更新`ENHANCED_OBS_CONFIG`中的维度
  3. 重新训练模型

### 2. **修改工作站设备数量**
- ❌ **不支持，需重新训练**
- **原因**：
  - 工作站容量`count`会影响瓶颈计算和负载均衡
  - 模型在训练时学习到的瓶颈模式基于当前配置
  - 例如：训练时"砂光机"是瓶颈（count=1），如果改为count=2，瓶颈会转移
- **如何支持**：
  1. 修改`WORKSTATIONS`中的`count`字段
  2. 使用新配置重新训练模型

### 3. **启用设备故障**
- ❌ **不支持（静态训练）**
- **原因**：
  - 当前模型使用`EQUIPMENT_FAILURE["enabled"] = False`训练
  - 观测空间中虽然有故障状态特征，但训练时从未遇到故障
- **如何支持**：
  1. 设置`EQUIPMENT_FAILURE["enabled"] = True`
  2. 配置故障参数（MTBF、MTTR）
  3. 重新训练模型

### 4. **启用紧急插单**
- ❌ **不支持（静态训练）**
- **原因**：同设备故障，训练时未启用此功能
- **如何支持**：重新训练并启用`EMERGENCY_ORDERS`

---

## 📊 模型训练配置总结

### 当前模型训练时使用的配置：

```python
# 工作站配置（固定）
WORKSTATIONS = {
    "带锯机": {"count": 1, "capacity": 1},
    "五轴加工中心": {"count": 2, "capacity": 1},
    "砂光机": {"count": 1, "capacity": 1},
    "组装台": {"count": 2, "capacity": 1},
    "包装台": {"count": 2, "capacity": 1},
}

# 产品类型（可扩展）
PRODUCT_ROUTES = {
    "黑胡桃木餐桌": [...],
    "橡木书柜": [...],
    "松木床架": [...],
    "樱桃木椅子": [...],
    # ✅ 可以添加新产品，只要使用上述5个工作站
}

# 训练订单范围
基础训练：8个订单，42个零件
泛化训练：5-8个订单，每个3-12个零件

# 仿真时间
SIMULATION_TIME = 600分钟（10小时）

# 禁用功能
EQUIPMENT_FAILURE["enabled"] = False
EMERGENCY_ORDERS["enabled"] = False
```

---

## 🎯 实际使用建议

### ✅ **推荐的自定义范围**

1. **订单配置**：
   - 3-8个订单
   - 总零件数：15-50个
   - 交期范围：200-700分钟
   - 到达时间：0-100分钟

2. **自定义产品**：
   - 使用5个系统工作站的任意组合
   - 工序数：2-6个
   - 单工序时间：5-30分钟

3. **任务难度**：
   - 理论完工时间：300-550分钟（50%-92%仿真时间）
   - 瓶颈负荷率：< 90%

### ⚠️ **边界测试**

如果想测试模型的极限能力，可以尝试：
- 零件数：60-80个（极限）
- 交期压力：理论完工时间 > 85%仿真时间
- 复杂工艺：6-8个工序的产品

### ❌ **不推荐的配置**

- 零件数 > 100（队列容量限制）
- 理论完工时间 > 仿真时间（必然无法完成）
- 工序时间 > 50分钟（超出训练范围）

---

## 🔧 如何扩展模型能力

如果需要支持当前不支持的功能，需要：

1. **修改配置文件**：更新`w_factory_config.py`
2. **验证观测空间**：确保维度匹配
3. **重新训练**：
   ```bash
   cd /root/MARL_FOR_W_Factory
   python mappo/ppo_marl_train.py
   ```
4. **测试新模型**：在应用中加载新训练的模型

---

## 📞 常见问题

**Q1: 为什么自定义产品完全支持，但自定义工作站不支持？**

A: 产品只是工艺路线的"名称"，模型看的是工序序列、加工时间等数值特征。但工作站数量直接影响观测空间维度，改变维度需要重新训练。

**Q2: 如果我的订单总零件数是70个，模型还能用吗？**

A: 可以用，但性能可能下降。模型训练时最多见过60个零件的场景。建议先用50个零件测试，确认效果后再增加。

**Q3: 能否只修改"砂光机"的设备数量为2，其他不变？**

A: 不推荐。这会改变整个系统的瓶颈结构，模型的决策策略可能不再适用。如需修改，建议重新训练。

**Q4: 随机订单生成会选择自定义产品吗？**

A: ✅ 会的！应用已支持在随机订单中包含自定义产品。

---

## 📈 总结

**核心原则**：模型对**订单内容**（产品、数量、交期、到达时间）的变化**非常鲁棒**，但对**系统结构**（工作站数量、设备容量）的变化**不鲁棒**。

这是因为泛化训练阶段就是针对订单多样性进行的，但系统结构在整个训练过程中保持不变。

